// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x", "debian-openssl-1.1.x"]
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// 用户模型
model User {
  id              String   @id @default(cuid())
  email           String   @unique // 邮箱（唯一）
  password        String   // 密码（加密后的）
  nickname        String   // 昵称
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@map("users")
}

// 用户作业模型
model UserHomework {
  id            String   @id @default(cuid())
  stageId       String   // 关卡ID (如: "1-1")
  nickname      String   // 用户昵称
  description   String?  // 可选的文字描述
  teamCount     Int      // 敌方队伍数量
  status        String   @default("pending") // pending, approved, rejected
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // 关联的图片
  images        HomeworkImage[]
  
  @@map("user_homework")
}

// 作业图片模型
model HomeworkImage {
  id           String       @id @default(cuid())
  homeworkId   String
  filename     String       // 存储的文件名
  originalName String       // 原始文件名
  mimeType     String       // 文件类型
  fileSize     Int          // 文件大小(bytes)
  order        Int          // 图片顺序
  uploadedAt   DateTime     @default(now())
  
  // 关联到作业
  homework     UserHomework @relation(fields: [homeworkId], references: [id], onDelete: Cascade)
  
  @@map("homework_images")
}


// 用户积分记录模型
model UserPoints {
  id          String   @id @default(cuid())
  nickname    String   // 用户昵称
  yearMonth   String   // 年月标识 (如: "2025-10")
  points      Float    @default(0) // 累计积分
  homeworkCount Int    @default(0) // 作业数量
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // 复合唯一索引，确保每个用户每个月只有一条记录
  @@unique([nickname, yearMonth])
  @@map("user_points")
}

// 月度奖池记录模型
model MonthlyPrizePool {
  id              String   @id @default(cuid())
  yearMonth       String   @unique // 年月标识 (如: "2025-10")
  basePool        Float    @default(200) // 基础奖池
  carryOver       Float    @default(0) // 上月累加
  totalPool       Float    // 总奖池 (basePool + carryOver)
  totalPoints     Float    @default(0) // 当月总积分
  distributed     Float    @default(0) // 已发放奖励
  nextCarryOver   Float    @default(0) // 下月累加
  isSettled       Boolean  @default(false) // 是否已结算
  settledAt       DateTime? // 结算时间
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@map("monthly_prize_pools")
}

// 积分历史记录模型
model PointsHistory {
  id          String   @id @default(cuid())
  nickname    String   // 用户昵称
  homeworkId  String   // 作业ID
  stageId     String   // 关卡ID
  teamCount   Int      // 队伍数量
  points      Float    // 获得积分
  isHalved    Boolean  @default(false) // 是否减半
  yearMonth   String   // 年月标识
  createdAt   DateTime @default(now())
  
  @@map("points_history")
}

// 系统配置模型
model SystemConfig {
  id              String   @id @default(cuid())
  key             String   @unique // 配置键名
  value           String   // 配置值
  description     String?  // 配置说明
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@map("system_configs")
}

// 消息模型
model Message {
  id          String   @id @default(cuid())
  userId      String   // 接收者用户ID
  senderId    String?  // 发送者用户ID（系统消息时为null）
  type        String   // 消息类型: system（系统消息）, admin（管理员消息）
  title       String   // 消息标题
  content     String   // 消息内容
  images      String?  // 图片URL列表（JSON数组格式）
  isRead      Boolean  @default(false) // 是否已读
  createdAt   DateTime @default(now())
  
  @@index([userId]) // 为userId创建索引，提高查询效率
  @@map("messages")
} 