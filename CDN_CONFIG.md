# EdgeOne CDN 配置指南

## 🔍 问题分析

### 图片无法加载的原因
1. **图片路径**：`/uploads/homework/xxx.png`
2. **现有配置**：只配置了 `^api` 不缓存
3. **问题**：`/uploads/` 路径仍被CDN缓存，导致新上传的图片显示旧内容或404

## ✅ 解决方案

### 方案一：代码层面 - 添加版本参数（已实施）

已在代码中为所有图片URL添加了版本参数：

- **管理员后台**：`/uploads/homework/xxx.png?t=1234567890` （实时时间戳）
- **用户查看**：`/uploads/homework/xxx.png?v=1234567890` （作业更新时间）

**优点**：
- ✅ 自动破坏CDN缓存
- ✅ 无需手动清除缓存
- ✅ 管理员总能看到最新图片

**缺点**：
- ⚠️ 管理员每次刷新都会重新请求（但确保看到最新）
- ⚠️ 需要部署新代码

### 方案二：CDN配置优化（推荐同时使用）

在 **腾讯云EdgeOne** 控制台配置以下缓存规则：

## 📋 EdgeOne 缓存规则配置

### 进入配置页面
1. 登录腾讯云EdgeOne控制台
2. 选择站点
3. 进入：**规则引擎** > **缓存配置**

### 配置规则（按优先级从高到低）

#### 规则1：API接口不缓存
```
规则名称：API接口
匹配条件：URL路径 - 匹配 - ^/api/.*
缓存配置：
  - 节点缓存 TTL：不缓存
  - 浏览器缓存 TTL：不缓存
```

#### 规则2：作业图片短缓存
```
规则名称：作业图片
匹配条件：URL路径 - 匹配 - ^/uploads/homework/.*
缓存配置：
  - 节点缓存 TTL：60秒（或遵循源站）
  - 浏览器缓存 TTL：0秒
  - 缓存键：完整URL（包含查询参数）
```

#### 规则3：其他上传文件
```
规则名称：其他上传文件
匹配条件：URL路径 - 匹配 - ^/uploads/.*
缓存配置：
  - 节点缓存 TTL：3600秒（1小时）
  - 浏览器缓存 TTL：3600秒
```

#### 规则4：静态图片资源
```
规则名称：静态图片
匹配条件：URL路径 - 匹配 - ^/images/.*
缓存配置：
  - 节点缓存 TTL：86400秒（24小时）
  - 浏览器缓存 TTL：86400秒
```

#### 规则5：其他图片文件
```
规则名称：其他图片
匹配条件：文件扩展名 - 包含 - png,jpg,jpeg,webp,gif
缓存配置：
  - 节点缓存 TTL：86400秒（24小时）
  - 浏览器缓存 TTL：86400秒
```

## 🔧 重要配置项

### 缓存键配置
确保 **缓存键包含查询参数**：

```
缓存键配置：
  ✅ 完整URL（推荐）
  或
  ✅ 自定义 - 包含所有查询参数
```

**说明**：这样 `/uploads/homework/a.png?t=123` 和 `/uploads/homework/a.png?t=456` 会被视为不同的资源。

### 源站配置
```
回源配置：
  - 回源协议：跟随请求协议
  - 回源Host：保持原Host
```

## 🧹 清除现有缓存

### 方法1：URL清除（推荐）
```
控制台 > 缓存清除 > URL清除
输入：https://yourdomain.com/uploads/homework/*
提交
```

### 方法2：目录清除
```
控制台 > 缓存清除 > 目录清除
输入：/uploads/homework/
提交
```

### 方法3：全站清除（慎用）
```
控制台 > 缓存清除 > 全站清除
确认清除
```

## 📊 验证配置

### 1. 检查响应头
使用浏览器开发者工具（F12）查看图片请求：

```
✅ 正确的响应头：
X-Cache-Status: MISS (首次请求)
X-Cache-Status: HIT (后续请求，但60秒内)
Cache-Control: max-age=0 (浏览器不缓存)

❌ 错误的响应头：
X-Cache-Status: HIT (新上传的图片不应该命中缓存)
Cache-Control: max-age=86400 (浏览器长期缓存)
```

### 2. 测试流程
1. 上传一张新图片
2. 在管理后台查看（应该立即显示）
3. 刷新页面（URL参数不同，重新请求）
4. 在前台查看已审核作业（应该正常显示）

### 3. 监控日志
```
EdgeOne 控制台 > 日志分析
筛选：/uploads/homework/
查看：
  - 缓存命中率
  - 回源次数
  - 错误状态码
```

## 🎯 最佳实践建议

### 当前配置（推荐）
```
✅ 代码添加版本参数（已实施）
✅ EdgeOne配置短TTL（60秒）
✅ 浏览器不缓存（0秒）
✅ 缓存键包含查询参数
```

### 性能优化
如果担心CDN成本：
- 管理员API：保持时间戳，确保准确性
- 用户API：使用作业更新时间，允许CDN缓存相同版本

### 成本控制
- 作业图片：60秒TTL，降低回源
- 静态资源：长期缓存，减少带宽
- API接口：不缓存，确保数据准确

## 🚀 部署步骤

1. **部署代码**
   ```bash
   npm run build
   npm start  # 或部署到服务器
   ```

2. **配置EdgeOne缓存规则**（按上述配置）

3. **清除旧缓存**（/uploads/homework/目录）

4. **测试验证**
   - 上传测试作业
   - 检查管理后台显示
   - 验证响应头

5. **监控观察**
   - 观察缓存命中率
   - 检查是否有404错误
   - 确认图片正常加载

## ❓ 常见问题

### Q1: 为什么还是看不到新图片？
A: 清除浏览器缓存（Ctrl+F5），或使用隐私模式测试

### Q2: CDN成本会增加吗？
A: 管理员查看会稍微增加回源次数，但用户访问仍可缓存，整体影响小

### Q3: 如何回滚？
A: 
- 代码回滚：移除URL参数
- CDN配置：删除或禁用规则

### Q4: 能否只配置CDN不改代码？
A: 可以，但建议两者结合：
- 只配置CDN：需要手动清除缓存或等待TTL过期
- 代码+CDN：自动处理，更可靠

## 📞 技术支持

如遇问题，请检查：
1. EdgeOne规则优先级是否正确
2. 缓存键是否包含查询参数
3. 是否清除了旧缓存
4. 响应头中的Cache-Status

